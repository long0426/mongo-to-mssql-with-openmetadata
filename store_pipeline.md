# 儲存pipeline指令
'''
db.pipeline_store.insertOne({ name: "assets_aggregation", description: "Complete aggregation of bank, securities, and insurance assets into asset_staging with all fields including policyType", pipeline: [ { $project: { traceId: 1, customerId: 1, payload: 1, totalBalance: 1, fetchedAt: 1 } }, { $unionWith: "insurance_raw" }, { $unionWith: "securities_raw" }, { $group: { _id: "$traceId" } }, { $project: { traceId: "$_id", _id: 0 } }, { $lookup: { from: "bank_raw", localField: "traceId", foreignField: "traceId", as: "bank_docs" } }, { $lookup: { from: "insurance_raw", localField: "traceId", foreignField: "traceId", as: "insurance_docs" } }, { $lookup: { from: "securities_raw", localField: "traceId", foreignField: "traceId", as: "securities_docs" } }, { $addFields: { bank_doc: { $first: "$bank_docs" }, insurance_doc: { $first: "$insurance_docs" }, securities_doc: { $first: "$securities_docs" } } }, { $addFields: { components: [ { $cond: [ { $gt: [ { $size: { $ifNull: ["$bank_doc.payload.bankAssets", []] } }, 0 ] }, { source: "BANK", status: "SUCCESS", amountInBase: "$bank_doc.totalBalance", sourceCurrency: "$bank_doc.payload.currency", exchangeRate: "1.0000", rawTraceId: "$traceId", fetchedAt: "$bank_doc.fetchedAt", assetDetails: "$bank_doc.payload.bankAssets", payloadRefId: "$bank_doc._id" }, "$$REMOVE"] }, { $cond: [ { $gt: [ { $size: { $ifNull: ["$securities_doc.payload.securitiesAssets", []] } }, 0 ] }, { source: "SECURITIES", status: "SUCCESS", amountInBase: "$securities_doc.totalMarketValue", sourceCurrency: "$securities_doc.payload.currency", exchangeRate: "1.0000", rawTraceId: "$traceId", fetchedAt: "$securities_doc.fetchedAt", assetDetails: "$securities_doc.payload.securitiesAssets", payloadRefId: "$securities_doc._id" }, "$$REMOVE"] }, { $cond: [ { $gt: [ { $size: { $ifNull: ["$insurance_doc.payload.insuranceAssets", []] } }, 0 ] }, { source: "INSURANCE", status: "SUCCESS", amountInBase: "$insurance_doc.totalCoverage", sourceCurrency: "$insurance_doc.payload.currency", exchangeRate: "1.0000", rawTraceId: "$traceId", fetchedAt: "$insurance_doc.fetchedAt", assetDetails: "$insurance_doc.payload.insuranceAssets", payloadRefId: "$insurance_doc._id" }, "$$REMOVE"] } ] } }, { $addFields: { assets: { $concatArrays: [ { $map: { input: { $ifNull: ["$bank_doc.payload.bankAssets", []] }, as: "ba", in: { customerId: "$bank_doc.customerId", source: "BANK", sourceStatus: "SUCCESS", assetName: "$$ba.accountId", assetType: "account", currency: "$$ba.currency", sourceCurrency: "$$ba.currency", exchangeRate: { $switch: { branches: [ { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 1.0 }, { case: { $and: [ { $eq: ["$$ba.currency","USD"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 32.0 }, { case: { $and: [ { $eq: ["$$ba.currency","JPY"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 0.23 }, { case: { $and: [ { $eq: ["$$ba.currency","EUR"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 35.0 }, { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","USD"] } ] }, then: 0.03 }, { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","JPY"] } ] }, then: 4.35 }, { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","EUR"] } ] }, then: 0.03 } ], default: 1.0 } }, baseCurrency: "$bank_doc.payload.currency", amountInBase: { $toString: { $multiply: [ { $toDouble: "$$ba.balance" }, { $switch: { branches: [ { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 1.0 }, { case: { $and: [ { $eq: ["$$ba.currency","USD"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 32.0 }, { case: { $and: [ { $eq: ["$$ba.currency","JPY"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 0.23 }, { case: { $and: [ { $eq: ["$$ba.currency","EUR"] }, { $eq: ["$bank_doc.payload.currency","TWD"] } ] }, then: 35.0 }, { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","USD"] } ] }, then: 0.03 }, { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","JPY"] } ] }, then: 4.35 }, { case: { $and: [ { $eq: ["$$ba.currency","TWD"] }, { $eq: ["$bank_doc.payload.currency","EUR"] } ] }, then: 0.03 } ], default: 1.0 } } ] } }, balance: "$$ba.balance", accountId: "$$ba.accountId", fetchedAt: "$bank_doc.fetchedAt", aggregatedAt: "$bank_doc.fetchedAt", traceId: "$traceId", payloadRefId: "$bank_doc._id", totalAssetValue: "$bank_doc.totalBalance", aggregationStatus: "COMPLETED" } } }, { $map: { input: { $ifNull: ["$securities_doc.payload.securitiesAssets", []] }, as: "sec", in: { customerId: "$securities_doc.customerId", source: "SECURITIES", sourceStatus: "SUCCESS", assetName: "$$sec.symbol", assetType: "$$sec.securityType", currency: "$$sec.currency", sourceCurrency: "$$sec.currency", exchangeRate: { $switch: { branches: [ { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 1.0 }, { case: { $and: [ { $eq: ["$$sec.currency","USD"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 32.0 }, { case: { $and: [ { $eq: ["$$sec.currency","JPY"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 0.23 }, { case: { $and: [ { $eq: ["$$sec.currency","EUR"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 35.0 }, { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","USD"] } ] }, then: 0.03 }, { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","JPY"] } ] }, then: 4.35 }, { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","EUR"] } ] }, then: 0.03 } ], default: 1.0 } }, baseCurrency: "$securities_doc.payload.currency", amountInBase: { $toString: { $multiply: [ { $toDouble: "$$sec.marketValue" }, { $switch: { branches: [ { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 1.0 }, { case: { $and: [ { $eq: ["$$sec.currency","USD"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 32.0 }, { case: { $and: [ { $eq: ["$$sec.currency","JPY"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 0.23 }, { case: { $and: [ { $eq: ["$$sec.currency","EUR"] }, { $eq: ["$securities_doc.payload.currency","TWD"] } ] }, then: 35.0 }, { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","USD"] } ] }, then: 0.03 }, { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","JPY"] } ] }, then: 4.35 }, { case: { $and: [ { $eq: ["$$sec.currency","TWD"] }, { $eq: ["$securities_doc.payload.currency","EUR"] } ] }, then: 0.03 } ], default: 1.0 } } ] } }, marketValue: "$$sec.marketValue", riskLevel: "$$sec.riskLevel", symbol: "$$sec.symbol", holdings: { $toString: "$$sec.holdings" }, fetchedAt: "$securities_doc.fetchedAt", aggregatedAt: "$securities_doc.fetchedAt", traceId: "$traceId", payloadRefId: "$securities_doc._id", totalAssetValue: "$securities_doc.totalMarketValue", aggregationStatus: "COMPLETED" } } }, { $map: { input: { $ifNull: ["$insurance_doc.payload.insuranceAssets", []] }, as: "ins", in: { customerId: "$insurance_doc.customerId", source: "INSURANCE", sourceStatus: "SUCCESS", assetName: "$$ins.policyNumber", assetType: "$$ins.policyType", policyType: "$$ins.policyType", currency: "$$ins.currency", sourceCurrency: "$$ins.currency", exchangeRate: { $switch: { branches: [ { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 1.0 }, { case: { $and: [ { $eq: ["$$ins.currency","USD"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 32.0 }, { case: { $and: [ { $eq: ["$$ins.currency","JPY"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 0.23 }, { case: { $and: [ { $eq: ["$$ins.currency","EUR"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 35.0 }, { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","USD"] } ] }, then: 0.03 }, { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","JPY"] } ] }, then: 4.35 }, { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","EUR"] } ] }, then: 0.03 } ], default: 1.0 } }, baseCurrency: "$insurance_doc.payload.currency", amountInBase: { $toString: { $multiply: [ { $toDouble: "$$ins.coverage" }, { $switch: { branches: [ { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 1.0 }, { case: { $and: [ { $eq: ["$$ins.currency","USD"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 32.0 }, { case: { $and: [ { $eq: ["$$ins.currency","JPY"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 0.23 }, { case: { $and: [ { $eq: ["$$ins.currency","EUR"] }, { $eq: ["$insurance_doc.payload.currency","TWD"] } ] }, then: 35.0 }, { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","USD"] } ] }, then: 0.03 }, { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","JPY"] } ] }, then: 4.35 }, { case: { $and: [ { $eq: ["$$ins.currency","TWD"] }, { $eq: ["$insurance_doc.payload.currency","EUR"] } ] }, then: 0.03 } ], default: 1.0 } } ] } }, coverage: "$$ins.coverage", policyNumber: "$$ins.policyNumber", premiumStatus: "$$ins.premiumStatus", fetchedAt: "$insurance_doc.fetchedAt", aggregatedAt: "$insurance_doc.fetchedAt", traceId: "$traceId", payloadRefId: "$insurance_doc._id", totalAssetValue: "$insurance_doc.totalCoverage", aggregationStatus: "COMPLETED" } } } ] } } }, { $project: { _id: 0, customerId: { $ifNull: ["$bank_doc.customerId", { $ifNull: ["$securities_doc.customerId", "$insurance_doc.customerId"] }] }, baseCurrency: { $ifNull: ["$bank_doc.payload.currency", { $ifNull: ["$securities_doc.payload.currency", "$insurance_doc.payload.currency"] }] }, components: 1, assets: 1, totalAssetValue: { $sum: { $map: { input: "$assets", as: "a", in: { $toDouble: "$$a.amountInBase" } } } }, aggregationStatus: { $literal: "COMPLETED" }, aggregatedAt: { $ifNull: ["$bank_doc.fetchedAt", { $ifNull: ["$securities_doc.fetchedAt", "$insurance_doc.fetchedAt"] }] }, traceId: "$traceId", _class: { $literal: "com.poc.svc.assets.entity.AssetStagingDocument" } } }, { $merge: { into: "asset_staging", on: "traceId", whenMatched: "keepExisting", whenNotMatched: "insert" } } ], createdAt: new Date() });
'''


# 在mongosh執行aggregation pipeline
'''
const doc = db.pipeline_store.findOne({ name: "assets_aggregation" });
db.bank_raw.aggregate(doc.pipeline);
'''